DROP TABLE IF EXISTS app;
DROP TABLE IF EXISTS cashgame_checkpoint;
DROP TABLE IF EXISTS cashgame_comment;
DROP TABLE IF EXISTS event_cashgame;
DROP TABLE IF EXISTS game;
DROP TABLE IF EXISTS location;
DROP TABLE IF EXISTS tournament_comment;
DROP TABLE IF EXISTS tournament_payout;
DROP TABLE IF EXISTS tournament_result;
DROP TABLE IF EXISTS user_sharing;
DROP TABLE IF EXISTS user_twitter;
DROP TABLE IF EXISTS video;
DROP TABLE IF EXISTS event;
DROP TABLE IF EXISTS tournament;
DROP TABLE IF EXISTS comment;
DROP TABLE IF EXISTS player;
DROP TABLE IF EXISTS homegame;
DROP TABLE IF EXISTS pb_user;
DROP TABLE IF EXISTS role;

CREATE TABLE homegame(
	homegame_id INT GENERATED BY DEFAULT AS IDENTITY NOT NULL PRIMARY KEY,
	name VARCHAR(50) NOT NULL,
	display_name VARCHAR(50) NULL,
	description VARCHAR(50) NULL,
	timezone VARCHAR(50) NOT NULL,
	default_buyin INT NOT NULL,
	currency VARCHAR(3) NOT NULL,
	currency_layout VARCHAR(20) NOT NULL,
	cashgames_enabled BIT NOT NULL,
	tournaments_enabled BIT NOT NULL,
	videos_enabled BIT NOT NULL,
	house_rules TEXT NULL
);

CREATE TABLE event(
	event_id INT GENERATED BY DEFAULT AS IDENTITY NOT NULL PRIMARY KEY,
	name VARCHAR(50) NOT NULL,
	bunch_id INT DEFAULT 0 NOT NULL,
    CONSTRAINT fk_bunch
        FOREIGN KEY(bunch_id)
        REFERENCES homegame(homegame_id)
);

CREATE TABLE location(
	location_id INT GENERATED BY DEFAULT AS IDENTITY NOT NULL PRIMARY KEY,
	name VARCHAR(50) NOT NULL,
	bunch_id INT DEFAULT 0 NOT NULL,
    CONSTRAINT fk_bunch
        FOREIGN KEY(bunch_id)
        REFERENCES homegame(homegame_id)
);

CREATE TABLE game(
	game_id INT GENERATED BY DEFAULT AS IDENTITY NOT NULL PRIMARY KEY,
	date date NOT NULL,
	timestamp TIMESTAMP DEFAULT CURRENT_TIMESTAMP NOT NULL,
	status INT NOT NULL,
	homegame_id INT DEFAULT 0 NOT NULL,
	location_id INT DEFAULT 0 NOT NULL,
    CONSTRAINT fk_bunch
        FOREIGN KEY(homegame_id)
        REFERENCES homegame(homegame_id),
    CONSTRAINT fk_location
        FOREIGN KEY(location_id)
        REFERENCES location(location_id)
);

CREATE TABLE event_cashgame(
	event_id INT NOT NULL,
	game_id INT NOT NULL,
    PRIMARY KEY (event_id, game_id),
    CONSTRAINT fk_event
        FOREIGN KEY(event_id)
        REFERENCES event(event_id),
    CONSTRAINT fk_game
        FOREIGN KEY(game_id)
        REFERENCES game(game_id)
);

CREATE TABLE player(
	player_id INT GENERATED BY DEFAULT AS IDENTITY NOT NULL PRIMARY KEY,
	homegame_id INT NOT NULL,
	user_id INT NULL,
	role_id INT NOT NULL,
	approved BIT DEFAULT 0::bit NOT NULL,
	player_name VARCHAR(50) NULL,
	color VARCHAR(10) NULL,
    CONSTRAINT fk_bunch
        FOREIGN KEY(homegame_id)
        REFERENCES homegame(homegame_id)
);

CREATE TABLE cashgame_checkpoint(
	checkpoint_id INT GENERATED BY DEFAULT AS IDENTITY NOT NULL PRIMARY KEY,
	game_id INT NOT NULL,
	player_id INT NOT NULL,
	type INT DEFAULT 0 NOT NULL,
	amount INT DEFAULT 0 NOT NULL,
	stack INT DEFAULT 0 NOT NULL,
	timestamp TIMESTAMP NOT NULL,
    CONSTRAINT fk_game
        FOREIGN KEY(game_id)
        REFERENCES game(game_id),
    CONSTRAINT fk_player
        FOREIGN KEY(player_id)
        REFERENCES player(player_id)
);

CREATE TABLE comment(
	comment_id INT GENERATED BY DEFAULT AS IDENTITY NOT NULL PRIMARY KEY,
	player_id INT NOT NULL,
	date TIMESTAMP NOT NULL,
	comment_text VARCHAR(1024) NOT NULL,
    CONSTRAINT fk_player
        FOREIGN KEY(player_id)
        REFERENCES player(player_id)
);

CREATE TABLE cashgame_comment(
	game_id INT NOT NULL,
	comment_id INT NOT NULL,
    PRIMARY KEY (game_id, comment_id),
    CONSTRAINT fk_game
        FOREIGN KEY(game_id)
        REFERENCES game(game_id),
    CONSTRAINT fk_comment
        FOREIGN KEY(comment_id)
        REFERENCES comment(comment_id)
);

CREATE TABLE role(
	role_id INT GENERATED BY DEFAULT AS IDENTITY NOT NULL PRIMARY KEY,
	role_name VARCHAR(50) NOT NULL
);

CREATE TABLE tournament(
	tournament_id INT GENERATED BY DEFAULT AS IDENTITY NOT NULL PRIMARY KEY,
	homegame_id INT NOT NULL,
	buyin INT NOT NULL,
	date date NOT NULL,
	duration INT NOT NULL,
	location VARCHAR(50) NOT NULL,
	timestamp TIMESTAMP NOT NULL,
	published BIT NOT NULL,
    CONSTRAINT fk_bunch
        FOREIGN KEY(homegame_id)
        REFERENCES homegame(homegame_id)
);

CREATE TABLE tournament_comment(
	tournament_id INT NOT NULL,
	comment_id INT NOT NULL,
    PRIMARY KEY (tournament_id, comment_id),
    CONSTRAINT fk_tournament
        FOREIGN KEY(tournament_id)
        REFERENCES tournament(tournament_id),
    CONSTRAINT fk_comment
        FOREIGN KEY(comment_id)
        REFERENCES comment(comment_id)
);

CREATE TABLE tournament_payout(
	tournament_id INT NOT NULL,
	position INT NOT NULL,
	payout INT NOT NULL,
    PRIMARY KEY (tournament_id, position),
    CONSTRAINT fk_tournament
        FOREIGN KEY(tournament_id)
        REFERENCES tournament(tournament_id)
);

CREATE TABLE tournament_result(
	tournament_id INT NOT NULL,
	player_id INT NOT NULL,
	position INT NOT NULL,
    PRIMARY KEY (tournament_id, player_id),
    CONSTRAINT fk_tournament
        FOREIGN KEY(tournament_id)
        REFERENCES tournament(tournament_id),
    CONSTRAINT fk_player
        FOREIGN KEY(player_id)
        REFERENCES player(player_id)
);

CREATE TABLE pb_user(
	user_id INT GENERATED BY DEFAULT AS IDENTITY NOT NULL PRIMARY KEY,
	token VARCHAR(50) NULL,
	user_name VARCHAR(50) NOT NULL,
	password VARCHAR(50) NULL,
	salt VARCHAR(50) NULL,
	role_id INT NOT NULL,
	real_name VARCHAR(50) NULL,
	display_name VARCHAR(50) NOT NULL,
	email VARCHAR(50) NULL,
    CONSTRAINT fk_role
        FOREIGN KEY(role_id)
        REFERENCES role(role_id)
);

CREATE TABLE app(
	app_id INT GENERATED BY DEFAULT AS IDENTITY NOT NULL PRIMARY KEY,
	app_key VARCHAR(50) NOT NULL,
	name VARCHAR(50) NOT NULL,
	user_id INT NOT NULL,
    CONSTRAINT fk_user
        FOREIGN KEY(user_id)
        REFERENCES pb_user(user_id)
);

CREATE TABLE user_sharing(
	user_id INT NOT NULL,
	service_name VARCHAR(50) NOT NULL,
    PRIMARY KEY (user_id, service_name),
    CONSTRAINT fk_user
        FOREIGN KEY(user_id)
        REFERENCES pb_user(user_id)
);

CREATE TABLE user_twitter(
	user_id INT NOT NULL PRIMARY KEY,
	twitter_name VARCHAR(100) NOT NULL,
	key VARCHAR(100) NOT NULL,
	secret VARCHAR(100) NOT NULL,
    CONSTRAINT fk_user
        FOREIGN KEY(user_id)
        REFERENCES pb_user(user_id)
);

CREATE TABLE video(
	video_id INT GENERATED BY DEFAULT AS IDENTITY NOT NULL PRIMARY KEY,
	homegame_id INT NOT NULL,
	date date NOT NULL,
	thumbnail VARCHAR(255) NOT NULL,
	length INT NOT NULL,
	width INT NOT NULL,
	height INT NOT NULL,
	source VARCHAR(20) NOT NULL,
	type VARCHAR(20) NOT NULL,
	hidden BIT NOT NULL,
    CONSTRAINT fk_bunch
        FOREIGN KEY(homegame_id) 
        REFERENCES homegame(homegame_id)
);
